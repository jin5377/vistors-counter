<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>일일 증가분 입력</title>
  <style>
    :root { --bg:#0b1020; --fg:#e8ecf1; --muted:#9aa6b2; --accent:#3aa3ff; }
    html,body{height:100%;margin:0;background:var(--bg);color:var(--fg);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,Apple SD Gothic Neo,Noto Sans KR,sans-serif}
    .wrap{max-width:640px;margin:0 auto;padding:28px 16px;display:grid;gap:16px}
    h1{font-size:clamp(20px,3.5vw,28px);margin:0 0 8px}
    .card{background:#0f1630;border:1px solid #1f2a44;border-radius:16px;padding:16px}
    label{display:block;font-size:14px;color:var(--muted);margin-bottom:6px}
    input,button{width:100%;padding:10px 12px;border-radius:10px;border:1px solid #2a375a;background:#0e1733;color:var(--fg)}
    input::placeholder{color:#64748b}
    .row{display:grid;grid-template-columns:1fr;gap:12px}
    .note{color:var(--muted);font-size:13px}
    .ok{color:#9ff9b1}
    .err{color:#ff9aa2}
    .hidden{display:none}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>국립대구과학관 800만 · 입력</h1>
      <p class="note">입력 단위: <strong>당일 입장 인원(일일 증가분)</strong>. 같은 날짜 입력은 마지막 값으로 반영됩니다(LWW).</p>
    </header>

    <section class="card">
      <form id="form" class="row" novalidate>
        <div>
          <label for="date">날짜</label>
          <input type="date" id="date" name="date" required />
        </div>

        <div>
          <label for="count">당일 입장 인원(일일 증가분)</label>
          <input
            type="number"
            id="count"
            name="count"
            inputmode="numeric"
            step="1"
            min="1"
            required
            placeholder="예: 1032"
            pattern="\d+"
          />
        </div>

        <div>
          <button id="submit" type="submit" aria-live="polite">제출</button>
        </div>

        <div>
          <span id="status" class="note" aria-live="polite" role="status">대기 중</span>
        </div>
      </form>
    </section>
  </div>

<script>
// ===== 설정 =====
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzhvDQtWL5S1WreuhPJiw7ODnv0KamWZHGVHBU0gsHInGkgPmBMpBQLv4J55q4CDT6qTQ/exec";
const KST_TZ = 'Asia/Seoul';

// ===== 유틸 =====
const $ = (s)=>document.querySelector(s);
const $$ = (s)=>document.querySelectorAll(s);
const statusEl = $('#status');
const btn = $('#submit');
const form = $('#form');

function setStatus(msg, cls='note'){ statusEl.textContent = msg; statusEl.className = cls; }

function kstToday(){
  // KST 기준 YYYY-MM-DD
  const now = new Date(new Date().toLocaleString('en-CA',{timeZone:KST_TZ}));
  const y = now.getFullYear();
  const m = String(now.getMonth()+1).padStart(2,'0');
  const d = String(now.getDate()).padStart(2,'0');
  return `${y}-${m}-${d}`;
}

function sanitizeInt(v){
  const raw = String(v).replace(/[\s,]/g,'');  // 공백·쉼표 제거
  if(!/^\d+$/.test(raw)) return NaN;          // 숫자만 허용(지수/부호/소수점 불가)
  const n = Number(raw);
  return Number.isSafeInteger(n) ? n : NaN;
}

function validate(date, count, maxDate){
  if(!/^\d{4}-\d{2}-\d{2}$/.test(date)) return '날짜 형식 오류';
  if(date > maxDate) return '미래 일자 불가';
  const n = sanitizeInt(count);
  if(!Number.isFinite(n) || n < 1) return '인원은 1 이상 정수';
  const MAX = 200000; // 필요 시 조정
  if(n > MAX) return `인원은 ${MAX.toLocaleString()} 이하`;
  return null;
}

function setMaxDateToday(){
  const today = kstToday();
  const dateEl = $('#date');
  dateEl.max = today;
  if(!dateEl.value) dateEl.valueAsDate = new Date(today);
}

function disableForm(disabled){
  for(const el of $$('#form input, #form button')) el.disabled = disabled;
}

async function submit(e){
  e?.preventDefault();
  if(btn.disabled) return;

  const dateEl = $('#date');
  const countEl = $('#count');
  const date = dateEl.value;
  const count = countEl.value;
  const err = validate(date, count, dateEl.max);
  if(err) { setStatus(err, 'note err'); return; }

  try{
    disableForm(true);
    setStatus('전송 중…');

    // 타임아웃 12초
    const ac = new AbortController();
    const t = setTimeout(()=>ac.abort('timeout'), 12000);

    const payload = new URLSearchParams();
    payload.set('date', date);
    payload.set('count', String(sanitizeInt(count)));

    // 오프라인 방지
    if(typeof navigator !== 'undefined' && navigator.onLine === false){
      throw new Error('오프라인 상태');
    }

    const res = await fetch(SCRIPT_URL, {
      method:'POST',
      headers:{ 'Content-Type':'application/x-www-form-urlencoded;charset=UTF-8' },
      body: payload,
      signal: ac.signal
    });
    clearTimeout(t);
    const text = await res.text();

    let ok = false;
    try { ok = res.ok && JSON.parse(text).status === 'ok'; }
    catch(_) { ok = res.ok && text.trim().toLowerCase() === 'ok'; }

    if(ok){
      setStatus('저장 완료. 이동합니다…', 'note ok');
      setTimeout(()=>{ window.location.href = 'index.html'; }, 300);
    } else {
      throw new Error(text || '서버 오류');
    }
  } catch(e){
    const msg = e?.name === 'AbortError' ? '요청 시간 초과' : (e?.message || '알 수 없는 오류');
    setStatus('오류: ' + msg, 'note err');
  } finally {
    disableForm(false);
  }
}

// 초기화
setMaxDateToday();
form.addEventListener('submit', submit);
btn.addEventListener('click', submit);

// 빠른 입력: 숫자 입력에서 Enter 시 제출
$('#count').addEventListener('keydown', (ev)=>{ if(ev.key==='Enter'){ submit(ev); }});
</script>
</body>
</html>
