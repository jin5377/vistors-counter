
<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>국립대구과학관 800만 카운트다운</title>
  <style>
    :root { --bg:#0b1020; --fg:#e8ecf1; --muted:#9aa6b2; --accent:#3aa3ff; --track:#1b2238; }
    html,body{height:100%;margin:0;background:var(--bg);color:var(--fg);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,Apple SD Gothic Neo,Noto Sans KR,sans-serif}
    .wrap{max-width:1000px;margin:0 auto;padding:32px 20px;display:grid;gap:20px}
    h1{font-size:clamp(22px,4vw,34px);margin:0 0 8px}
    .kpis{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:14px}
    .card{background:#0f1630;border:1px solid #1f2a44;border-radius:16px;padding:16px}
    .label{font-size:13px;color:var(--muted);letter-spacing:.2px}
    .value{font-variant-numeric:tabular-nums;line-height:1.1;font-weight:700;font-size:clamp(24px,4.5vw,40px)}
    .bar{height:18px;background:var(--track);border-radius:999px;overflow:hidden;border:1px solid #1f2a44}
    .fill{height:100%;width:0;background:linear-gradient(90deg,var(--accent),#7ed3ff);transition:width .4s ease}
    .note{color:var(--muted);font-size:14px}
    .footer{display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap;color:var(--muted);font-size:13px}
    .error{color:#ff9aa2}
    .sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0}
    .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .btn{padding:8px 12px;border:1px solid #2a375a;border-radius:10px;background:#0e1733;color:var(--fg);cursor:pointer}
    .btn:active{transform:translateY(1px)}
    table{width:100%;border-collapse:collapse;font-size:14px}
    th,td{padding:10px;border-bottom:1px solid #1f2a44;text-align:left}
    thead th{color:var(--muted);font-weight:600}
    tfoot td{font-weight:700}
    a.btn{display:inline-block;text-decoration:none}
    .right{justify-content:flex-end}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>국립대구과학관 800만 카운트다운</h1>
      <p class="note" id="asof">데이터 로드 중…</p>
    </header>

    <section class="kpis" aria-label="누적 및 목표 현황">
      <div class="card" role="group" aria-labelledby="k1l">
        <div class="label" id="k1l">오늘 기준 누적</div>
        <div class="value" id="cum">-</div>
      </div>
      <div class="card" role="group" aria-labelledby="k2l">
        <div class="label" id="k2l">목표</div>
        <div class="value" id="target">8,000,000</div>
      </div>
      <div class="card" role="group" aria-labelledby="k3l">
        <div class="label" id="k3l">남은 인원</div>
        <div class="value" id="remain">-</div>
      </div>
      <div class="card" role="group" aria-labelledby="k4l">
        <div class="label" id="k4l">달성률</div>
        <div class="value" id="rate">-</div>
      </div>
    </section>

    <section aria-label="진행률 바">
      <div class="bar" aria-hidden="true"><div class="fill" id="fill"></div></div>
      <p class="sr-only" id="bar-label">달성률 진행 바</p>
    </section>

    <section class="card">
      <div class="row" style="justify-content:space-between">
        <strong>일자별 입력 내역</strong>
        <span class="note" id="status">-</span>
      </div>
      <table id="tbl">
        <thead>
          <tr><th>날짜</th><th>입력 인원</th></tr>
        </thead>
        <tbody></tbody>
        <tfoot>
          <tr><td>합계</td><td id="sumCell">0</td></tr>
        </tfoot>
      </table>
      <div class="row right" style="margin-top:10px">
        <a class="btn" href="input.html">누적인원 입력</a>
        <button class="btn" id="exportBtn" title="JSON으로 내보내기">내보내기</button>
        <input type="file" id="importFile" accept="application/json" style="display:none" />
        <button class="btn" id="importBtn" title="JSON 불러오기">불러오기</button>
        <button class="btn" id="resetBtn" title="모든 입력을 초기화합니다">초기화</button>
      </div>
    </section>

    <footer class="footer">
      <div>입력은 <code>input.html</code>에서 수행. 같은 날짜는 자동 합산. 저장 위치: 브라우저 <code>localStorage</code>.</div>
      <div id="lastUpdated">-</div>
    </footer>
  </div>

<script>
const KEY = 'dsm_counts';
const TARGET = 8000000;

// ----- storage utils -----
function load() {
  try {
    const raw = localStorage.getItem(KEY);
    if (!raw) return [];
    const arr = JSON.parse(raw);
    return Array.isArray(arr) ? arr : [];
  } catch { return []; }
}
function save(arr) { localStorage.setItem(KEY, JSON.stringify(arr)); }
function fmt(n){ return Number(n||0).toLocaleString('ko-KR'); }

function aggregateByDate(entries) {
  const map = new Map();
  for (const e of entries) {
    if (!e || !e.date || typeof e.count !== 'number') continue;
    map.set(e.date, (map.get(e.date) || 0) + e.count);
  }
  return Array.from(map.entries()).sort((a,b)=> a[0].localeCompare(b[0]));
}

function draw() {
  const entries = load();
  const total = entries.reduce((s,e)=> s + (typeof e.count==='number' ? e.count : 0), 0);
  const remain = Math.max(TARGET - total, 0);
  const rate = Math.max(Math.min((total / TARGET) * 100, 100), 0);

  document.getElementById('cum').textContent = fmt(total) + ' 명';
  document.getElementById('target').textContent = fmt(TARGET);
  document.getElementById('remain').textContent = fmt(remain) + ' 명';
  document.getElementById('rate').textContent = rate.toFixed(2) + '%';
  document.getElementById('fill').style.width = rate + '%';
  document.getElementById('asof').textContent = '브라우저 저장 데이터 기준';

  // table
  const tbody = document.querySelector('#tbl tbody');
  tbody.innerHTML = '';
  const aggregated = aggregateByDate(entries);
  for (const [date, cnt] of aggregated) {
    const tr = document.createElement('tr');
    const td1 = document.createElement('td'); td1.textContent = date;
    const td2 = document.createElement('td'); td2.textContent = fmt(cnt);
    tr.appendChild(td1); tr.appendChild(td2);
    tbody.appendChild(tr);
  }
  document.getElementById('sumCell').textContent = fmt(total);
  const last = entries.length ? new Date(Math.max(...entries.map(e => e.ts || 0))) : null;
  document.getElementById('lastUpdated').textContent = last ? ('업데이트: ' + new Date(last).toLocaleString('ko-KR')) : '업데이트 이력 없음';
}

// Ingest from query ?date=YYYY-MM-DD&count=123
function ingestFromQuery() {
  const p = new URLSearchParams(location.search);
  if (!p.has('date') || !p.has('count')) return false;
  const date = p.get('date');
  const count = Number(p.get('count'));
  if (!date || !/\d{4}-\d{2}-\d{2}/.test(date)) return false;
  if (!Number.isFinite(count) || count <= 0) return false;
  const entries = load();
  entries.push({ date, count, ts: Date.now() });
  save(entries);
  // Remove query from URL without reload
  history.replaceState({}, document.title, location.pathname);
  document.getElementById('status').textContent = '데이터 소스: URL 매개변수';
  return true;
}

// buttons
document.getElementById('resetBtn').addEventListener('click', () => {
  if (confirm('모든 입력을 초기화할까요?')) {
    localStorage.removeItem(KEY);
    draw();
  }
});
document.getElementById('exportBtn').addEventListener('click', () => {
  const data = load();
  const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = 'dsm_counts_backup.json'; a.click();
  URL.revokeObjectURL(url);
});
document.getElementById('importBtn').addEventListener('click', () => {
  document.getElementById('importFile').click();
});
document.getElementById('importFile').addEventListener('change', (e) => {
  const file = e.target.files[0]; if (!file) return;
  const reader = new FileReader();
  reader.onload = () => {
    try {
      const arr = JSON.parse(reader.result);
      if (!Array.isArray(arr)) throw new Error('형식 오류');
      save(arr); draw(); alert('불러오기 완료');
    } catch (err) { alert('불러오기 실패: ' + err.message); }
  };
  reader.readAsText(file, 'utf-8');
});

// run
const added = ingestFromQuery();
draw();
if (!added) document.getElementById('status').textContent = '데이터 소스: localStorage';
</script>
</body>
</html>
