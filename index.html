
<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>국립대구과학관 800만 카운트다운</title>
  <style>
    :root { --bg:#0b1020; --fg:#e8ecf1; --muted:#9aa6b2; --accent:#3aa3ff; --track:#1b2238; }
    html,body{height:100%;margin:0;background:var(--bg);color:var(--fg);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,Apple SD Gothic Neo,Noto Sans KR,sans-serif}
    .wrap{max-width:1000px;margin:0 auto;padding:32px 20px;display:grid;gap:20px}
    h1{font-size:clamp(22px,4vw,34px);margin:0 0 8px}
    .kpis{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:14px}
    .card{background:#0f1630;border:1px solid #1f2a44;border-radius:16px;padding:16px}
    .label{font-size:13px;color:var(--muted);letter-spacing:.2px}
    .value{font-variant-numeric:tabular-nums;line-height:1.1;font-weight:700;font-size:clamp(24px,4.5vw,40px)}
    .bar{height:18px;background:var(--track);border-radius:999px;overflow:hidden;border:1px solid #1f2a44}
    .fill{height:100%;width:0;background:linear-gradient(90deg,var(--accent),#7ed3ff);transition:width .4s ease}
    .note{color:var(--muted);font-size:14px}
    .footer{display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap;color:var(--muted);font-size:13px}
    .error{color:#ff9aa2}
    .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .btn{padding:8px 12px;border:1px solid #2a375a;border-radius:10px;background:#0e1733;color:var(--fg);cursor:pointer;text-decoration:none}
    .btn:active{transform:translateY(1px)}
    table{width:100%;border-collapse:collapse;font-size:14px}
    th,td{padding:10px;border-bottom:1px solid #1f2a44;text-align:left}
    thead th{color:var(--muted);font-weight:600}
    tfoot td{font-weight:700}
    .right{justify-content:flex-end}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>국립대구과학관 800만 카운트다운</h1>
      <p class="note" id="asof">데이터 로드 중…</p>
    </header>

    <section class="kpis" aria-label="누적 및 목표 현황">
      <div class="card" role="group" aria-labelledby="k1l">
        <div class="label" id="k1l">오늘 기준 누적</div>
        <div class="value" id="cum">-</div>
      </div>
      <div class="card" role="group" aria-labelledby="k2l">
        <div class="label" id="k2l">목표</div>
        <div class="value" id="target">8,000,000</div>
      </div>
      <div class="card" role="group" aria-labelledby="k3l">
        <div class="label" id="k3l">남은 인원</div>
        <div class="value" id="remain">-</div>
      </div>
      <div class="card" role="group" aria-labelledby="k4l">
        <div class="label" id="k4l">달성률</div>
        <div class="value" id="rate">-</div>
      </div>
    </section>

    <section aria-label="진행률 바">
      <div class="bar" aria-hidden="true"><div class="fill" id="fill"></div></div>
      <p class="note" id="status">데이터 소스: Google Sheets</p>
    </section>

    <section class="card">
      <div class="row" style="justify-content:space-between">
        <strong>일자별 입력 내역</strong>
        <span class="note" id="rowsInfo">-</span>
      </div>
      <table id="tbl">
        <thead>
          <tr><th>날짜</th><th>입력 인원</th></tr>
        </thead>
        <tbody></tbody>
        <tfoot>
          <tr><td>합계</td><td id="sumCell">0</td></tr>
        </tfoot>
      </table>
      <div class="row right" style="margin-top:10px">
        <a class="btn" href="input.html">누적인원 입력</a>
      </div>
    </section>

    <footer class="footer">
      <div>입력은 <code>input.html</code>(관리자 전용)에서 수행. 같은 날짜는 마지막 입력값으로 반영(LWW).</div>
      <div id="lastUpdated">-</div>
    </footer>
  </div>

<script>
const TARGET = 8000000;
// 아래 URL을 Apps Script 웹앱 배포 URL로 교체하세요.
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzbCLNnYPzCEdKbWRxQUg-DlV0LfqF5TaOFMiFYb3e5fXuW05mbpTOIZQnwNv9L1pMpgA/exec";

function fmt(n){ return Number(n||0).toLocaleString('ko-KR'); }

async function fetchSheet() {
  const res = await fetch(SCRIPT_URL, { method:'GET', headers:{'Cache-Control':'no-cache'} });
  if (!res.ok) throw new Error('시트 요청 실패 ' + res.status);
  const data = await res.json(); // [["날짜","인원"],["2025-08-20","100"], ...]
  return data;
}

function normalizeRows(arr){
  // 헤더 제거 후 {date, count} 배열로 변환
  return arr.slice(1)
    .map(r => ({ date: String(r[0]||'').slice(0,10), count: Number(r[1]||0) }))
    .filter(r => /^\d{4}-\d{2}-\d{2}$/.test(r.date) && Number.isFinite(r.count) && r.count>0);
}

function aggregateByDate(rows){
  // 마지막 입력 우선(LWW). 같은 날짜가 여러 번 있으면 마지막 행의 값으로 대체
  const map = new Map();
  for (const r of rows) map.set(r.date, r.count); // overwrite keeps last
  return Array.from(map.entries()).sort((a,b) => a[0].localeCompare(b[0]));
}

async function draw(){
  try {
    const raw = await fetchSheet();
    const rows = normalizeRows(raw);
    const agg = aggregateByDate(rows);
    const lastAgg = aggregateByDate(rows);
    const total = lastAgg.reduce((s, [d, c]) => s + c, 0);
    const remain = Math.max(TARGET - total, 0);
    const rate = Math.max(Math.min((total / TARGET) * 100, 100), 0);

    // KPI
    document.getElementById('cum').textContent = fmt(total) + ' 명';
    document.getElementById('remain').textContent = fmt(remain) + ' 명';
    document.getElementById('rate').textContent = rate.toFixed(2) + '%';
    document.getElementById('fill').style.width = rate + '%';
    document.getElementById('asof').textContent = '데이터 소스: Google Sheets (읽기 전용)';
    document.getElementById('rowsInfo').textContent = `행 수: ${rows.length}`;

    // 표
    const tbody = document.querySelector('#tbl tbody');
    tbody.innerHTML = '';
    for (const [date, cnt] of lastAgg){
      const tr = document.createElement('tr');
      const td1 = document.createElement('td'); td1.textContent = date;
      const td2 = document.createElement('td'); td2.textContent = fmt(cnt);
      tr.appendChild(td1); tr.appendChild(td2);
      tbody.appendChild(tr);
    }
    document.getElementById('sumCell').textContent = fmt(total);
    document.getElementById('lastUpdated').textContent = '업데이트: ' + new Date().toLocaleString('ko-KR');
  } catch (err){
    document.getElementById('status').textContent = '오류: ' + err.message;
    document.getElementById('status').className = 'note error';
  }
}

draw();
</script>
</body>
</html>
