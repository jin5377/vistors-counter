<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>국립대구과학관 800만 카운트다운</title>
  <style>
    :root { --bg:#0b1020; --fg:#e8ecf1; --muted:#9aa6b2; --accent:#3aa3ff; --track:#1b2238; }
    html,body{height:100%;margin:0;background:var(--bg);color:var(--fg);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,Apple SD Gothic Neo,Noto Sans KR,sans-serif}
    .wrap{max-width:1000px;margin:0 auto;padding:32px 20px;display:grid;gap:20px}
    h1{font-size:clamp(22px,4vw,34px);margin:0 0 8px}
    .kpis{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:14px}
    .card{background:#0f1630;border:1px solid #1f2a44;border-radius:16px;padding:16px}
    .label{font-size:13px;color:var(--muted);letter-spacing:.2px}
    .value{font-variant-numeric:tabular-nums;line-height:1.1;font-weight:700;font-size:clamp(24px,4.5vw,40px)}
    .bar{height:18px;background:var(--track);border-radius:999px;overflow:hidden;border:1px solid #1f2a44}
    .fill{height:100%;width:0;background:linear-gradient(90deg,var(--accent),#7ed3ff);transition:width .4s ease}
    .note{color:var(--muted);font-size:14px}
    .footer{display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap;color:var(--muted);font-size:13px}
    .error{color:#ff9aa2}
    table{width:100%;border-collapse:collapse;font-size:14px}
    th,td{padding:10px;border-bottom:1px solid #1f2a44;text-align:left}
    thead th{color:var(--muted);font-weight:600}
    tfoot td{font-weight:700}
    .right{justify-content:flex-end; display:flex}
    .btn{padding:8px 12px;border:1px solid #2a375a;border-radius:10px;background:#0e1733;color:var(--fg);cursor:pointer;text-decoration:none}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>국립대구과학관 800만 카운트다운</h1>
      <p class="note" id="asof">데이터 로드 중…</p>
    </header>

    <section class="kpis" aria-label="누적 및 목표 현황">
      <div class="card" role="group" aria-labelledby="k1l">
        <div class="label" id="k1l">오늘 기준 누적(일일 증가분 합산)</div>
        <div class="value" id="cum">-</div>
      </div>
      <div class="card" role="group" aria-labelledby="k2l">
        <div class="label" id="k2l">목표</div>
        <div class="value" id="target">8,000,000</div>
      </div>
      <div class="card" role="group" aria-labelledby="k3l">
        <div class="label" id="k3l">남은 인원</div>
        <div class="value" id="remain">-</div>
      </div>
      <div class="card" role="group" aria-labelledby="k4l">
        <div class="label" id="k4l">달성률</div>
        <div class="value" id="rate">-</div>
      </div>
    </section>

    <section aria-label="진행률 바">
      <div class="bar" aria-hidden="true"><div class="fill" id="fill"></div></div>
      <p class="note" id="status">데이터 소스: Google Sheets</p>
    </section>

    <section class="card">
      <div class="right">
        <a class="btn" href="input.html">일일 증가분 입력</a>
      </div>
      <strong>일자별 입력 내역</strong>
      <table id="tbl">
        <thead>
          <tr><th>날짜</th><th>입력 인원</th></tr>
        </thead>
        <tbody></tbody>
        <tfoot>
          <tr><td>합계</td><td id="sumCell">0</td></tr>
        </tfoot>
      </table>
      <p class="note" id="rowsInfo">-</p>
    </section>

    <footer class="footer">
      <div>입력은 <code>input.html</code>(관리자 전용)에서 수행. 같은 날짜는 <strong>마지막 값</strong>으로 반영(LWW).</div>
      <div id="lastUpdated">-</div>
    </footer>
  </div>

<script>
const TARGET = 8000000;
// 본인 스크립트 URL로 교체
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzhvDQtWL5S1WreuhPJiw7ODnv0KamWZHGVHBU0gsHInGkgPmBMpBQLv4J55q4CDT6qTQ/exec";

function fmt(n){ return Number(n||0).toLocaleString('ko-KR'); }

async function fetchSheet() {
  const res = await fetch(SCRIPT_URL + "?t=" + Date.now(), { method:'GET' });
  if (!res.ok) throw new Error('시트 요청 실패 ' + res.status);
  const txt = await res.text();
  try {
    return JSON.parse(txt);
  } catch (e) {
    throw new Error('JSON 파싱 실패: ' + e.message);
  }
}

// 응답이 [ ['날짜','인원'], ... ] 또는 [ ['2025-08-20', 100], ... ] 모두 처리
function normalizeRows(arr){
  if (!Array.isArray(arr)) return [];
  let start = 0;
  if (arr.length && Array.isArray(arr[0])) {
    const h0 = String(arr[0][0] ?? '').trim();
    const h1 = String(arr[0][1] ?? '').trim();
    if (h0 === '날짜' && h1 === '인원') start = 1;
  }
  return arr.slice(start)
    .map(r => ({ date: String(r[0]||'').slice(0,10), count: Number(r[1]||0) }))
    .filter(r => /^\d{4}-\d{2}-\d{2}$/.test(r.date) && Number.isFinite(r.count) && r.count>0);
}

// 같은 날짜는 마지막 값으로 대체(LWW)
function aggregateByDate(rows){
  const map = new Map();
  for (const r of rows) map.set(r.date, r.count);
  return Array.from(map.entries()).sort((a,b) => a[0].localeCompare(b[0]));
}

async function draw(){
  try {
    const raw = await fetchSheet();
    const rows = normalizeRows(raw);
    const lastAgg = aggregateByDate(rows);
    const total = lastAgg.reduce((s, [, c]) => s + c, 0);
    const remain = Math.max(TARGET - total, 0);
    const rate = Math.max(Math.min((total / TARGET) * 100, 100), 0);

    // KPI
    document.getElementById('cum').textContent = fmt(total) + ' 명';
    document.getElementById('remain').textContent = fmt(remain) + ' 명';
    document.getElementById('rate').textContent = rate.toFixed(2) + '%';
    document.getElementById('fill').style.width = rate + '%';
    document.getElementById('asof').textContent = '기준: 일일 증가분 합산';

    // 표
    const tbody = document.querySelector('#tbl tbody');
    tbody.innerHTML = '';
    for (const [date, cnt] of lastAgg){
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${date}</td><td>${fmt(cnt)}</td>`;
      tbody.appendChild(tr);
    }

    document.getElementById('sumCell').textContent = fmt(total);
    document.getElementById('rowsInfo').textContent = `행 수: ${rows.length}, 날짜 수: ${lastAgg.length}`;
    document.getElementById('lastUpdated').textContent = '업데이트: ' + new Date().toLocaleString('ko-KR');
    document.getElementById('status').textContent = '데이터 소스: Google Sheets';
    document.getElementById('status').className = 'note';
  } catch (err){
    document.getElementById('status').textContent = '오류: ' + err.message;
    document.getElementById('status').className = 'note error';
  }
}

draw();
</script>
</body>
</html>
